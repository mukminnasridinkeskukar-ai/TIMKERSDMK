<div class="container">
  <h2>üìù Login Box SIPANDAI-ASN</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="username" type="email" placeholder="Email (Username)" required>
    <input id="password" type="password" placeholder="Password" required>
    <button id="loginBtn" type="button">üîê LOGIN</button>
    <div id="loginMsg"></div>
  </div>

  <!-- PANEL ADMIN -->
  <div id="adminPanel" class="hidden admin-panel">
    <button type="button"
      onclick="window.location.href='https://sipandaiasn.blogspot.com/p/dashboard-admin.html'">
      üìä Buka Dashboard Admin
    </button>
  </div>

  <!-- FORM ABSENSI -->
  <form id="absenForm" class="hidden">
    <button type="button" id="logoutBtn" class="logout-btn">üö™ LOGOUT</button>

    <label>Tanggal Absensi</label>
    <input type="date" id="tanggal" required>

    <label>Jam Absensi</label>
    <input type="time" id="jam" required>

    <input id="nama" placeholder="Nama Lengkap" required>
    <input id="nip" placeholder="NIP" required>

    <label>Platform Digital</label>
    <div class="btn-group">
      <button type="button" data-platform="Zoom">Zoom</button>
      <button type="button" data-platform="Youtube">YouTube</button>
    </div>

    <label>Evaluasi Penyelenggara</label>
    <select id="eval_penyelenggara" required></select>

    <label>Evaluasi Fasilitator / Narasumber</label>
    <select id="eval_narasumber" required></select>

    <label>Evaluasi Sarana Prasarana</label>
    <select id="eval_sarana" required></select>

    <textarea id="komentar" placeholder="Komentar / Saran"></textarea>

    <button type="submit">‚úÖ KIRIM ABSENSI</button>
  </form>

  <div id="notif"></div>
</div>

<style>
.container{
  max-width:1150px;
  margin:40px auto;
  padding:24px;
  background:#f8fafc;
  border-radius:18px;
  font-family:Segoe UI,Arial;
  box-shadow:0 12px 35px rgba(0,0,0,.12)
}
h2{text-align:center;margin-bottom:20px}

input,select,textarea{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:14px
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#2563eb;
  color:#fff;
  font-weight:700;
  cursor:pointer
}

.hidden{display:none}

.btn-group{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:12px
}
.btn-group button{
  background:#e5e7eb;
  color:#000
}
.btn-group button.active{
  background:#16a34a;
  color:#fff
}

.logout-btn{
  background:#ef4444;
  margin-bottom:14px;
}

.admin-panel{
  margin-bottom:16px;
  text-align:right
}
.admin-panel button{
  background:#7c3aed
}

#loginMsg,#notif{
  text-align:center;
  font-weight:600;
  margin-top:10px
}

.notif-success{
  color:#166534;
  background:#dcfce7;
  border:1px solid #86efac;
  padding:12px;
  border-radius:12px;
}

.notif-error{
  color:#991b1b;
  background:#fee2e2;
  border:1px solid #fca5a5;
  padding:12px;
  border-radius:12px;
}
</style>

<script>
/* ================== KONFIG ================== */
const WEBAPP = "https://script.google.com/macros/s/AKfycbyjfcwwczu-QXjCVKAnwuaYx4VoIpd5eP2SQ5LVyx_gjnPWlmGboLmX84FVSl4uQeNc/exec";
/* =========================================== */

const loginBox   = document.getElementById("loginBox");
const absenForm  = document.getElementById("absenForm");
const adminPanel = document.getElementById("adminPanel");
const loginBtn   = document.getElementById("loginBtn");
const notif      = document.getElementById("notif");
const loginMsg   = document.getElementById("loginMsg");

let platform = "";

/* ===== OPSI EVALUASI ===== */
const evaluasi = [
  "Sangat Kurang Baik",
  "Kurang Baik",
  "Baik",
  "Baik Sekali",
  "Sangat Baik Sekali"
];

["eval_penyelenggara","eval_narasumber","eval_sarana"].forEach(id=>{
  const s = document.getElementById(id);
  s.innerHTML = "";
  const d = document.createElement("option");
  d.value = "";
  d.text  = "-- Pilih Penilaian --";
  d.disabled = true;
  d.selected = true;
  s.appendChild(d);

  evaluasi.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.text  = v;
    s.appendChild(o);
  });
});

/* ===== PILIH PLATFORM ===== */
document.querySelectorAll(".btn-group button").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".btn-group button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    platform = btn.dataset.platform;
  };
});

/* ===== LOGIN (BERSIH & STABIL) ===== */
loginBtn.onclick = ()=>{
  loginBtn.disabled = true;
  loginMsg.innerText = "‚è≥ Memverifikasi...";

  fetch(WEBAPP,{
    method:"POST",
    body:JSON.stringify({
      type:"login",
      username: username.value.trim(),
      password: password.value.trim()
    })
  })
  .then(r=>r.json())
  .then(d=>{
    loginBtn.disabled = false;

    if(d.status==="ok"){
      localStorage.setItem("admin_user", username.value.trim());
      localStorage.setItem("admin_pass", password.value.trim());

      loginBox.classList.add("hidden");
      absenForm.classList.remove("hidden");
      loginMsg.innerText = "";

      if(d.role==="ADMIN"){
        adminPanel.classList.remove("hidden");
      }else{
        adminPanel.classList.add("hidden");
      }
    }else{
      loginMsg.innerText="‚ùå Email atau Password salah / akun nonaktif";
    }
  })
  .catch(()=>{
    loginBtn.disabled = false;
    loginMsg.innerText="‚ö†Ô∏è Gagal terhubung ke server";
  });
};

/* ===== LOGOUT ===== */
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("admin_user");
  localStorage.removeItem("admin_pass");

  absenForm.reset();
  loginBox.classList.remove("hidden");
  absenForm.classList.add("hidden");
  adminPanel.classList.add("hidden");
  notif.innerText = "";
  platform = "";
};

/* ===== SUBMIT ABSENSI ===== */
absenForm.onsubmit = e=>{
  e.preventDefault();
  notif.className = "";

  if(!platform){
    notif.classList.add("notif-error");
    notif.innerText="‚ö†Ô∏è Pilih platform digital";
    return;
  }

  fetch(WEBAPP,{
    method:"POST",
    body:JSON.stringify({
      type:"absen",
      tanggal:tanggal.value,
      jam:jam.value,
      nama:nama.value.trim(),
      nip:nip.value.trim(),
      platform:platform,
      eval_penyelenggara:eval_penyelenggara.value,
      eval_narasumber:eval_narasumber.value,
      eval_sarana:eval_sarana.value,
      komentar:komentar.value.trim()
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.status==="success"){
      notif.classList.add("notif-success");
      notif.innerText="‚úÖ Absensi berhasil dicatat";
      setTimeout(()=>document.getElementById("logoutBtn").click(),1500);
    }else{
      notif.classList.add("notif-error");
      notif.innerText="‚õî Absensi ditolak sistem";
    }
  })
  .catch(()=>{
    notif.classList.add("notif-error");
    notif.innerText="‚ö†Ô∏è Gagal mengirim absensi";
  });
};
</script>
